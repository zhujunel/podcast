<style lang="scss">
  @import "./styles/base";
  @import "./styles/animate";
</style>

<script>
  /* eslint-disable no-unused-vars,no-undef */
  // ENV
  const env = 'production' // 'development' or 'production'
  // APP VERSION
  const version = 'v1'

  // development and production host
  const hosts = {
    development: `http://api.caixie.la/${version}`,
    production: `https://api.caixie.top/${version}`
  }
  const APPID = 'S11SeYT2W'
  const APP_API = `${hosts[env]}/apps/${APPID}`

  import wepy from 'wepy'
  import mitt from 'mitt'
  import WxUtils from './utils/WxUtils'
  import 'wepy-async-function'

  export default class extends wepy.app {
    constructor () {
      super()
      // æ³¨å†Œä¸­é—´ä»¶
      this.use('requestfix')
      this.use('promisify')
      // å¤„ç†å…¨å±€è¯·æ±‚ Header
      this.intercept('request', {
        config (p) {
          p.header = this.createAuthHeader()
          return p
        }
      })
      this.intercept('uploadFile', {
        config (p) {
          p.header = this.createAuthHeader()
          return p
        },
        success (p) {
          return p.data
        }
      })
    }

    /**
     * æ„é€ æƒé™å¤´éƒ¨
     */
    createAuthHeader () {
      const _token = wepy.$instance.globalData.auth._token
      const header = {}
      if (_token) {
        header['Authorization'] = `Bearer ${_token}`
      }
      return header
    }
    emitter = mitt()
    onLaunch (param) {
      // æ ¡éªŒSDK
      WxUtils.checkSDK()
      // åŒæ­¥æƒé™æ•°æ®
      this.syncStoreConfig('_token')
      this.syncStoreConfig('user')

      // è·å–ä¿å­˜åœºæ™¯å€¼
      if (param && param.scene) {
        console.info('[scene]onLaunch scene', param.scene)
        wepy.$instance.globalData.scene = param.scene
        console.info('[auth]onLaunch end')
      }
      this.device = wx.getSystemInfoSync()  //  è·å–è®¾å¤‡ä¿¡æ¯
      // console.log(this.device)
      this.globalData.isIpx = this.device.model.indexOf('iPhone X') >= 0
    }

    syncStoreConfig (key) {
      try {
        const value = wepy.getStorageSync(key)
        if (value !== '') {
          // console.info(`[auth]${key} sync success `)
          wepy.$instance.globalData.auth[key] = value
        }
      } catch (e) {
        console.warn(`[auth]${key} sync fail `)
      }
    }

    config = {
      pages: [
        'pages/index',
        'pages/love',
        'pages/me',
        'pages/love/new'
      ],
      window: {
        backgroundTextStyle: 'light',
        navigationBarBackgroundColor: '#fff',
        navigationBarTitleText: 'æ„¿å›ï¼Œå¤šé‡‡æ’·ğŸŒ¸',
        navigationBarTextStyle: 'black'
      },
      tabBar: {
        color: '#ACB3BA',
        selectedColor: '#1F1F1F',
        backgroundColor: '#FFFFFF',
        // borderStyle: 'white',
        list: [{
          pagePath: 'pages/index',
          iconPath: 'images/icon/icon-love.png',
          selectedIconPath: 'images/icon/icon-love--active.png',
          text: 'æœ€çˆ±'
        }, {
          pagePath: 'pages/index',
          iconPath: 'images/icon/icon-story.png',
          selectedIconPath: 'images/icon/icon-story--active.png',
          text: 'æ•…äº‹'
        }, {
          pagePath: 'pages/me',
          iconPath: 'images/icon/icon-me.png',
          selectedIconPath: 'images/icon/icon-me--active.png',
          text: 'æˆ‘è‡ªå·±'
        }]
      }
    }

    globalData = {
      baseUrl: APP_API,
      auth: {},
      scene: '',
      user: null,
      userInfo: null
    }
  }
</script>
